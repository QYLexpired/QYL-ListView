"use strict";const siyuan=require("siyuan");class QylListViewPlugin extends siyuan.Plugin{constructor(){super(...arguments),this.qylListViewState=null}onload(){this.initQYLListView()}onunload(){this.removeQYLListView()}uninstall(){this.removeQYLListView()}initQYLListView(){this.qylListViewState&&this.removeQYLListView(),this.createQYLListViewStandalone()}removeQYLListView(){this.qylListViewState&&(this.qylListViewState.commonMenuObserver&&(this.qylListViewState.commonMenuObserver.disconnect(),this.qylListViewState.commonMenuObserver=null),this.qylListViewState.isClickMonitorActive=!1,this.qylListViewState.commonMenuElement=null,this.qylListViewState.searchAttempts=0,this.qylListViewState.isCreatingListView=!1,this.qylListViewState=null)}createQYLListViewStandalone(){this.qylListViewState={plugin:this,isClickMonitorActive:!1,commonMenuObserver:null,commonMenuElement:null,searchAttempts:0,maxSearchAttempts:15,searchInterval:100,isCreatingListView:!1};const t=()=>{this.qylListViewState&&(this.qylListViewState.commonMenuElement=document.querySelector("#commonMenu"),this.qylListViewState.commonMenuElement?e():(this.qylListViewState.searchAttempts+=1,this.qylListViewState.searchAttempts<this.qylListViewState.maxSearchAttempts&&setTimeout(t,this.qylListViewState.searchInterval)))},e=()=>{this.qylListViewState&&this.qylListViewState.commonMenuElement&&(this.qylListViewState.commonMenuObserver&&this.qylListViewState.commonMenuObserver.disconnect(),this.qylListViewState.commonMenuObserver=new MutationObserver(t=>{t.forEach(t=>{var e;if("attributes"===t.type&&"class"===t.attributeName){const s=t.target,n=null!==(e=t.oldValue)&&void 0!==e?e:"",a=s.className,l=n.includes("fn__none"),r=a.includes("fn__none");l&&!r&&i()}})}),this.qylListViewState.commonMenuObserver.observe(this.qylListViewState.commonMenuElement,{attributes:!0,attributeFilter:["class"],attributeOldValue:!0}))},i=()=>{if(!this.qylListViewState||this.qylListViewState.isCreatingListView||document.querySelector("#QYL-ListView"))return;this.qylListViewState.isCreatingListView=!0;const t=d();t&&"NodeList"===t.type&&s(t.id),setTimeout(()=>{this.qylListViewState&&(this.qylListViewState.isCreatingListView=!1)},100)},s=async t=>{const e=n();if(!e)return;const i=Array.from(e.children),s=i.find(t=>"export"===t.getAttribute("data-id")),r=i.find(t=>"updateAndCreatedAt"===t.getAttribute("data-id")),o=e.querySelector("#QYL-ListView");if(!s&&r&&!o){const i=await l(t);e.insertBefore(i,r),i.nextSibling?e.insertBefore(a(),i.nextSibling):e.appendChild(a())}},n=()=>document.querySelector("#commonMenu .b3-menu__items"),a=(t="b3-menu__separator")=>{const e=document.createElement("button");return e.className=t,e.setAttribute("data-qyl-separator","true"),e},l=async t=>{const e=document.createElement("button");return e.id="QYL-ListView",e.className="b3-menu__item",e.innerHTML=`\n        <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg>\n        <span class="b3-menu__label">${this.i18n.listview}</span>\n        <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>\n      `,e.appendChild(r(t)),e},r=t=>{const e=[c(this.i18n.listviewmindmap,"#iconGlobalGraph","list-view","mindmap",t),c(this.i18n.listviewkanban,"#iconMenu","list-view","kanban",t),c(this.i18n.listviewtable,"#iconTable","list-view","table",t),c(this.i18n.listviewtimeline,"#iconClock","list-view","timeline",t),c(this.i18n.listviewlist,"#iconList","list-view","list",t)];return o("QYLListViewSub",e)},o=(t,e)=>{const i=document.createElement("div");i.id=t,i.className="b3-menu__submenu";const s=document.createElement("div");return s.className="b3-menu__items",e.forEach(t=>{s.appendChild(t)}),i.appendChild(s),i},c=(t,e,i,s,n="")=>{const a=document.createElement("button");return a.className="b3-menu__item",a.setAttribute("data-QYL-attr-id",n),a.setAttribute("custom-attr-name",i),a.setAttribute("custom-attr-value",s),a.innerHTML=`\n        <svg class="b3-menu__icon"><use xlink:href="${e}"></use></svg>\n        <span class="b3-menu__label">${t}</span>\n      `,a.onclick=async()=>{const t=a.getAttribute("data-QYL-attr-id"),e=a.getAttribute("custom-attr-name"),i=a.getAttribute("custom-attr-value");if(!t||!e||!i)return;const s=`custom-${e}`;try{await u(t,s,i)}catch(t){}},a},u=async(t,e,i)=>{document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${t}"]`).forEach(t=>t.setAttribute(e,i));return m(t,{[e]:i})},m=async(t,e)=>{const i=await h("/api/attr/setBlockAttrs",{id:t,attrs:e});return w(i)},h=async(t,e)=>{try{const i=await fetch(t,{body:JSON.stringify(e),method:"POST",headers:{"Content-Type":"application/json",Authorization:"Token "}});return i.ok?await i.json():null}catch(t){return null}},w=t=>t&&0===t.code?t.data:null,d=()=>(t=>{var e;const i=document.querySelectorAll(t);if(1===i.length){const t=i[0];if(t.dataset.nodeId)return{id:t.dataset.nodeId,type:null!==(e=t.dataset.type)&&void 0!==e?e:""}}return null})(".protyle-wysiwyg--select");(()=>{this.qylListViewState&&!this.qylListViewState.isClickMonitorActive&&(this.qylListViewState.isClickMonitorActive=!0,t())})()}}module.exports=QylListViewPlugin;